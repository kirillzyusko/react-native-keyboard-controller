name: 📝 Post size diff

on:
  workflow_run:
    workflows: ["🧪 Size diff (collect)"]
    types:
      - completed

jobs:
  post-comment:
    name: 📊 Post npm package size diff
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      pull-requests: write # Allows commenting on the PR

    steps:
      - name: Download size artifact
        uses: actions/download-artifact@v3
        with:
          name: package-size

      - name: Extract size data
        run: |
          OLD_SIZE=$(cat size.txt)
          echo "OLD_SIZE=$OLD_SIZE" >> $GITHUB_ENV

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ### 📊 Package size report
            | Current size  | Target Size   | Difference               |
            | ------------- | ------------- | ------------------------ |
            | ${{ env.NEW_SIZE }} bytes | ${{ env.OLD_SIZE }} bytes | ${{ env.DIFF }} bytes ${{ env.SIGN }} |
